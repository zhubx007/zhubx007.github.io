<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Ceph Bucket Notification(Ceph 存储桶通知)</title>
    <url>/archives/24828.html/</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>存储桶通知提供了一种在存储同上发生某些事件时将消息发送到 radosgw 之外的机制。当前，通知可以发送到：HTTP、AMQP 0.9.1 和 Kafka</p>
<h1 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h1><h2 id="搭建一个-ceph-对象存储集群"><a href="#搭建一个-ceph-对象存储集群" class="headerlink" title="搭建一个 ceph 对象存储集群"></a>搭建一个 ceph 对象存储集群</h2><p>参考 ceph 官方文档搭建：<span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmNlcGguY29tL2VuL2xhdGVzdC8=">https://docs.ceph.com/en/latest/<i class="fa fa-external-link-alt"></i></span></p>
<h2 id="搭建一个简易的-server，提供-API-接收通知"><a href="#搭建一个简易的-server，提供-API-接收通知" class="headerlink" title="搭建一个简易的 server，提供 API 接收通知"></a>搭建一个简易的 server，提供 API 接收通知</h2><blockquote>
<p>文件 <code>server.py</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler, HTTPServer</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">S</span>(<span class="params">BaseHTTPRequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_set_response</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.send_response(<span class="number">200</span>)</span><br><span class="line">        self.send_header(<span class="string">&quot;Content-type&quot;</span>, <span class="string">&quot;text/html&quot;</span>)</span><br><span class="line">        self.end_headers()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span>(<span class="params">self</span>):</span></span><br><span class="line">        logging.info(<span class="string">f&quot;GET request\nPath: <span class="subst">&#123;self.path&#125;</span>\nHeaders:\n<span class="subst">&#123;self.headers&#125;</span>\n&quot;</span>)</span><br><span class="line">        self._set_response()</span><br><span class="line">        self.wfile.write(<span class="string">f&quot;GET request for <span class="subst">&#123;self.path&#125;</span>&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_POST</span>(<span class="params">self</span>):</span></span><br><span class="line">        content_length = <span class="built_in">int</span>(self.headers[<span class="string">&quot;Content-Length&quot;</span>])</span><br><span class="line">        post_data = self.rfile.read(content_length)</span><br><span class="line">        logging.info(</span><br><span class="line">            <span class="string">f&quot;POST request\nPath: <span class="subst">&#123;self.path&#125;</span>\nHeaders:\n<span class="subst">&#123;self.headers&#125;</span>\nBody:\n<span class="subst">&#123;post_data.decode(<span class="string">&#x27;utf-8&#x27;</span>)&#125;</span>\n&quot;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self._set_response()</span><br><span class="line">        self.wfile.write(<span class="string">f&quot;POST request for <span class="subst">&#123;self.path&#125;</span>&quot;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">server_class=HTTPServer, handler_class=S, port=<span class="number">8080</span></span>):</span></span><br><span class="line">    logging.basicConfig(level=logging.INFO)</span><br><span class="line">    server_address = (<span class="string">&quot;&quot;</span>, port)</span><br><span class="line">    httpd = server_class(server_address, handler_class)</span><br><span class="line">    logging.info(<span class="string">&quot;Starting httpd...\n&quot;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        httpd.serve_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    httpd.server_close()</span><br><span class="line">    logging.info(<span class="string">&quot;Stopping httpd...\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(argv) == <span class="number">2</span>:</span><br><span class="line">        run(port=<span class="built_in">int</span>(argv[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        run()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行 <code>python3 server.py 8080</code></p>
</blockquote>
<h2 id="创建-topic、bucket-以及-bucket-更新通知机制"><a href="#创建-topic、bucket-以及-bucket-更新通知机制" class="headerlink" title="创建 topic、bucket 以及 bucket 更新通知机制"></a>创建 topic、bucket 以及 bucket 更新通知机制</h2><blockquote>
<p>文件 <code>notify.py</code></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> boto3</span><br><span class="line"><span class="keyword">import</span> botocore</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;This class configures bucket notifications for both kafka and rabbitmq endpoints for real-time message queuing&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Notifier</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># creates all needed arguments for the program to run</span></span><br><span class="line">        parser = argparse.ArgumentParser()</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-e&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--endpoint-url&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;endpoint url for s3 object storage&quot;</span>,</span><br><span class="line">            required=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-a&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--access-key&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;access key for s3 object storage&quot;</span>,</span><br><span class="line">            required=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-s&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--secret-key&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;secret key for s3 object storage&quot;</span>,</span><br><span class="line">            required=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(<span class="string">&quot;-b&quot;</span>, <span class="string">&quot;--bucket-name&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;s3 bucket name&quot;</span>, required=<span class="literal">True</span>)</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-ke&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--kafka-endpoint&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;kafka endpoint in which rgw will send notifications to&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-ae&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--amqp-endpoint&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;amqp endpoint in which rgw will send notifications to&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-he&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--http-endpoint&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;http endpoint in which rgw will send notifications to&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-t&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--topic&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;topic name in which rgw will send notifications to&quot;</span>,</span><br><span class="line">            required=<span class="literal">True</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-f&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--filter&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;filter such as prefix, suffix, metadata or tags&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-o&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--opaque&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;opaque data that will be sent in the notifications&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-x&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--exchange&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;amqp exchange name (mandatory for amqp endpoints)&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">        )</span><br><span class="line">        parser.add_argument(</span><br><span class="line">            <span class="string">&quot;-n&quot;</span>,</span><br><span class="line">            <span class="string">&quot;--notification&quot;</span>,</span><br><span class="line">            <span class="built_in">help</span>=<span class="string">&quot;notification name, allows for setting multiple notifications on the same bucket&quot;</span>,</span><br><span class="line">            required=<span class="literal">False</span>,</span><br><span class="line">            default=<span class="string">&quot;configuration&quot;</span>,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># parsing all arguments</span></span><br><span class="line">        args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># building instance vars</span></span><br><span class="line">        self.endpoint_url = args.endpoint_url</span><br><span class="line">        self.access_key = args.access_key</span><br><span class="line">        self.secret_key = args.secret_key</span><br><span class="line">        self.bucket_name = args.bucket_name</span><br><span class="line">        self.kafka_endpoint = args.kafka_endpoint</span><br><span class="line">        self.http_endpoint = args.http_endpoint</span><br><span class="line">        self.amqp_endpoint = args.amqp_endpoint</span><br><span class="line">        self.topic = args.topic</span><br><span class="line">        self.<span class="built_in">filter</span> = args.<span class="built_in">filter</span></span><br><span class="line">        self.opaque = args.opaque</span><br><span class="line">        self.exchange = args.exchange</span><br><span class="line">        self.notification = args.notification</span><br><span class="line">        self.sns = boto3.client(</span><br><span class="line">            <span class="string">&quot;sns&quot;</span>,</span><br><span class="line">            endpoint_url=self.endpoint_url,</span><br><span class="line">            aws_access_key_id=self.access_key,</span><br><span class="line">            region_name=<span class="string">&quot;default&quot;</span>,</span><br><span class="line">            aws_secret_access_key=self.secret_key,</span><br><span class="line">            config=botocore.client.Config(signature_version=<span class="string">&quot;s3&quot;</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        self.s3 = boto3.client(</span><br><span class="line">            <span class="string">&quot;s3&quot;</span>,</span><br><span class="line">            endpoint_url=self.endpoint_url,</span><br><span class="line">            aws_access_key_id=self.access_key,</span><br><span class="line">            aws_secret_access_key=self.secret_key,</span><br><span class="line">            region_name=<span class="string">&quot;default&quot;</span>,</span><br><span class="line">            config=botocore.client.Config(signature_version=<span class="string">&quot;s3&quot;</span>),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot; This function creates and sns-like topic with configured push endpoint&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_sns_topic</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        attributes = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.opaque:</span><br><span class="line">            attributes[<span class="string">&quot;OpaqueData&quot;</span>] = self.opaque</span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case wanted MQ endpoint is kafka</span></span><br><span class="line">        <span class="keyword">if</span> self.kafka_endpoint:</span><br><span class="line">            attributes[<span class="string">&quot;push-endpoint&quot;</span>] = <span class="string">&quot;kafka://&quot;</span> + self.kafka_endpoint</span><br><span class="line">            attributes[<span class="string">&quot;kafka-ack-level&quot;</span>] = <span class="string">&quot;broker&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case wanted MQ endpoint is rabbitmq</span></span><br><span class="line">        <span class="keyword">elif</span> self.amqp_endpoint:</span><br><span class="line">            attributes[<span class="string">&quot;push-endpoint&quot;</span>] = <span class="string">&quot;amqp://&quot;</span> + self.amqp_endpoint</span><br><span class="line">            attributes[<span class="string">&quot;amqp-exchange&quot;</span>] = self.exchange_name</span><br><span class="line">            attributes[<span class="string">&quot;amqp-ack-level&quot;</span>] = <span class="string">&quot;broker&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case wanted MQ endpoint is http</span></span><br><span class="line">        <span class="keyword">elif</span> self.http_endpoint:</span><br><span class="line">            attributes[<span class="string">&quot;push-endpoint&quot;</span>] = <span class="string">&quot;http://&quot;</span> + self.http_endpoint</span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case wanted MQ endpoint is not provided by the user</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> Exception(<span class="string">&quot;please configure a push endpoint!&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># creates the wanted sns-like topic on RGW and gets the topic&#x27;s ARN</span></span><br><span class="line">        self.topic_arn = self.sns.create_topic(Name=self.topic, Attributes=attributes)[<span class="string">&quot;TopicArn&quot;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;&quot;&quot; This function configures bucket notification for object creation and removal &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure_bucket_notification</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># creates a bucket if it doesn&#x27;t exists</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.s3.head_bucket(Bucket=self.bucket_name)</span><br><span class="line">        <span class="keyword">except</span> botocore.exceptions.ClientError:</span><br><span class="line">            self.s3.create_bucket(Bucket=self.bucket_name)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># initial dictionary</span></span><br><span class="line">        bucket_notifications_configuration = &#123;</span><br><span class="line">            <span class="string">&quot;TopicConfigurations&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;Id&quot;</span>: self.notification,</span><br><span class="line">                    <span class="string">&quot;TopicArn&quot;</span>: self.topic_arn,</span><br><span class="line">                    <span class="string">&quot;Events&quot;</span>: [<span class="string">&quot;s3:ObjectCreated:*&quot;</span>, <span class="string">&quot;s3:ObjectRemoved:*&quot;</span>],</span><br><span class="line">                &#125;,</span><br><span class="line">            ],</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># in case the user has provided a filter to use</span></span><br><span class="line">        <span class="keyword">if</span> self.<span class="built_in">filter</span>:</span><br><span class="line">            bucket_notifications_configuration[<span class="string">&quot;TopicConfigurations&quot;</span>][<span class="number">0</span>].update(</span><br><span class="line">                &#123;<span class="string">&quot;Filter&quot;</span>: json.loads(self.<span class="built_in">filter</span>)&#125;,</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># pushed the notification configuration to the bucket</span></span><br><span class="line">        self.s3.put_bucket_notification_configuration(</span><br><span class="line">            Bucket=self.bucket_name,</span><br><span class="line">            NotificationConfiguration=bucket_notifications_configuration,</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># creates an notifier instance from class</span></span><br><span class="line">    notifier = Notifier()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># create sns-like topic sent to MQ endpoint</span></span><br><span class="line">    notifier.create_sns_topic()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># configures object creation and removal based notification for the bucket</span></span><br><span class="line">    notifier.configure_bucket_notification()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>执行 <code>python3 notify.py -h</code> 查看帮助</p>
</blockquote>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><ul>
<li>往 <code>notify.py</code> 脚本中新建的 bucket 中上传文件，可以看到如下信息：</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;Records&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;eventVersion&quot;</span>:<span class="string">&quot;2.2&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;eventSource&quot;</span>:<span class="string">&quot;ceph:s3&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;awsRegion&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;eventTime&quot;</span>:<span class="string">&quot;2021-04-29 03:44:09.933439Z&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;eventName&quot;</span>:<span class="string">&quot;s3:ObjectCreated:Put&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;userIdentity&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;principalId&quot;</span>:<span class="string">&quot;7b10eee340c84201bc99ca5d8fa4f61d&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;requestParameters&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;sourceIPAddress&quot;</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;responseElements&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;x-amz-request-id&quot;</span>:<span class="string">&quot;cffa8590-7621-4f07-99b4-5f5f5a30baab.4451.127&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;x-amz-id-2&quot;</span>:<span class="string">&quot;1163-default-default&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;s3&quot;</span>:&#123;</span><br><span class="line">                <span class="attr">&quot;s3SchemaVersion&quot;</span>:<span class="string">&quot;1.0&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;configurationId&quot;</span>:<span class="string">&quot;configuration&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;bucket&quot;</span>:&#123;</span><br><span class="line">                    <span class="attr">&quot;name&quot;</span>:<span class="string">&quot;test-notifications&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;ownerIdentity&quot;</span>:&#123;</span><br><span class="line">                        <span class="attr">&quot;principalId&quot;</span>:<span class="string">&quot;7b10eee340c84201bc99ca5d8fa4f61d&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">&quot;arn&quot;</span>:<span class="string">&quot;arn:aws:s3:::test-notifications&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;id&quot;</span>:<span class="string">&quot;cffa8590-7621-4f07-99b4-5f5f5a30baab.4478.23&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;object&quot;</span>:&#123;</span><br><span class="line">                    <span class="attr">&quot;key&quot;</span>:<span class="string">&quot;charging-simple-logic.png&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;size&quot;</span>:<span class="number">9613</span>,</span><br><span class="line">                    <span class="attr">&quot;etag&quot;</span>:<span class="string">&quot;e517ba5e9e85f66a5bba81109ab4652e&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;versionId&quot;</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;sequencer&quot;</span>:<span class="string">&quot;892B8A60D2CAEF37&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;metadata&quot;</span>:[</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">&quot;key&quot;</span>:<span class="string">&quot;x-amz-content-sha256&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;val&quot;</span>:<span class="string">&quot;91af6adc28cbee8a82d186604f03a062b4ee64e26caebbd5d5da8e41182a1cdf&quot;</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="attr">&quot;key&quot;</span>:<span class="string">&quot;x-amz-date&quot;</span>,</span><br><span class="line">                            <span class="attr">&quot;val&quot;</span>:<span class="string">&quot;20210429T034409Z&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    ],</span><br><span class="line">                    <span class="attr">&quot;tags&quot;</span>:[</span><br><span class="line"></span><br><span class="line">                    ]</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;eventId&quot;</span>:<span class="string">&quot;1619667849.938461.e517ba5e9e85f66a5bba81109ab4652e&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;opaqueData&quot;</span>:<span class="string">&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ceph</category>
      </categories>
      <tags>
        <tag>ceph</tag>
      </tags>
  </entry>
  <entry>
    <title>配置 pip 国内源</title>
    <url>/archives/39470.html/</url>
    <content><![CDATA[<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><ol>
<li>创建.pip目录</li>
</ol>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir -p <span class="variable">$HOME</span>/.pip</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>写入pip.conf配置文件</li>
</ol>
<figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="string">&quot;[global]</span></span></span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple&quot; &gt;$HOME/.pip/pip.conf</span><br></pre></td></tr></table></figure>

<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><ol>
<li>在用户目录下，创建pip目录，例如C:\Users\Administrator\pip</li>
<li>写入pip.ini配置文件，内容如下：</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure>

<h1 id="推荐国内源"><a href="#推荐国内源" class="headerlink" title="推荐国内源"></a>推荐国内源</h1><table>
<thead>
<tr>
<th>源</th>
<th>地址</th>
</tr>
</thead>
<tbody><tr>
<td>清华大学</td>
<td><span class="exturl" data-url="aHR0cHM6Ly9weXBpLnR1bmEudHNpbmdodWEuZWR1LmNuL3NpbXBsZQ==">https://pypi.tuna.tsinghua.edu.cn/simple<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>阿里云</td>
<td><span class="exturl" data-url="aHR0cDovL21pcnJvcnMuYWxpeXVuLmNvbS9weXBpL3NpbXBsZQ==">http://mirrors.aliyun.com/pypi/simple<i class="fa fa-external-link-alt"></i></span></td>
</tr>
<tr>
<td>豆瓣</td>
<td><span class="exturl" data-url="aHR0cDovL3B5cGkuZG91YmFuLmNvbS9zaW1wbGU=">http://pypi.douban.com/simple<i class="fa fa-external-link-alt"></i></span></td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>pip</tag>
      </tags>
  </entry>
  <entry>
    <title>获取某个 Bucket 下的分片信息</title>
    <url>/archives/22614.html/</url>
    <content><![CDATA[<h1 id="获取-bucket-id"><a href="#获取-bucket-id" class="headerlink" title="获取 bucket id"></a>获取 bucket id</h1><figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> BUCKET_NAME=<span class="string">&quot;bucket01&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> BUCKET_ID=`radosgw-admin bucket stats --bucket=<span class="variable">$&#123;BUCKET_NAME&#125;</span> | grep -w id | awk -F <span class="string">&#x27;&quot;&#x27;</span> <span class="string">&#x27;&#123;print $4&#125;&#x27;</span>`</span></span><br></pre></td></tr></table></figure>

<h1 id="查看-bucket-index-中的-omap-信息"><a href="#查看-bucket-index-中的-omap-信息" class="headerlink" title="查看 bucket.index 中的 omap 信息"></a>查看 bucket.index 中的 omap 信息</h1><figure class="highlight console"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> INDEX_POOL=<span class="string">&quot;default.rgw.buckets.index&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> OBJECT_MAP=<span class="string">&quot;.dir.<span class="variable">$&#123;BUCKET_ID&#125;</span>&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> rados -p <span class="variable">$&#123;INDEX_POOL&#125;</span> listomapkeys <span class="variable">$&#123;OBJECT_MAP&#125;</span></span></span><br><span class="line">_multipart_software/DingTalk_v4.5.5.18.exe.2~WG7XrXpvoUIfH9a1Sa8cChNsIfRMUNU.1</span><br><span class="line">_multipart_software/DingTalk_v4.5.5.18.exe.2~WG7XrXpvoUIfH9a1Sa8cChNsIfRMUNU.2</span><br><span class="line">_multipart_software/DingTalk_v4.5.5.18.exe.2~WG7XrXpvoUIfH9a1Sa8cChNsIfRMUNU.3</span><br><span class="line">_multipart_software/DingTalk_v4.5.5.18.exe.2~WG7XrXpvoUIfH9a1Sa8cChNsIfRMUNU.4</span><br><span class="line">_multipart_software/DingTalk_v4.5.5.18.exe.2~WG7XrXpvoUIfH9a1Sa8cChNsIfRMUNU.meta</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ceph</category>
      </categories>
      <tags>
        <tag>ceph</tag>
        <tag>bucket</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 中使用 kolla-ansible 快速部署 OpenStack All-In-One</title>
    <url>/archives/60765.html/</url>
    <content><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><hr>
<ul>
<li>系统：CentOS 7</li>
<li>两块网卡：<ul>
<li>eth0：172.16.140.15   管理网</li>
<li>eth1：192.168.1.16    业务网/存储网</li>
</ul>
</li>
<li>CPU：8C</li>
<li>内存：16G</li>
<li>系统盘：50G</li>
<li>Ceph OSD 盘：100G</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><hr>
<p><code>NOTE：整个安装过程，并没有使用 python 虚拟环境。</code></p>
<h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><ol>
<li><p>安装 <code>python</code> 构建依赖</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install python-devel libffi-devel gcc openssl-devel libselinux-python -y</span></span><br></pre></td></tr></table></figure></li>
<li><p>安装 <code>pip</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo easy_install pip</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pip install -U pip</span></span><br></pre></td></tr></table></figure></li>
<li><p>安装 <code>ansible &gt;=2.8</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install epel-release -y</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install ansible -y</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="安装-kolla-ansible"><a href="#安装-kolla-ansible" class="headerlink" title="安装 kolla-ansible"></a>安装 kolla-ansible</h3><ol>
<li><p>使用 <code>pip</code> 安装 <code>kolla-ansible</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo pip install kolla-ansible</span></span><br></pre></td></tr></table></figure>

<p> <strong>如果出现以下情况</strong></p>
<p> <img src="https://zbx-pic.oss-cn-shanghai.aliyuncs.com/iseeyou/20200205200301456.png" alt="安装kolla-ansible失败"></p>
<p> 则需要使用命令 <code>sudo pip install kolla-ansible -I</code></p>
</li>
<li><p>创建 <code>/etc/kolla</code> 目录</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo mkdir -p /etc/kolla</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown <span class="variable">$USER</span>:<span class="variable">$USER</span> /etc/kolla</span></span><br></pre></td></tr></table></figure></li>
<li><p>拷贝 <code>globals.yml</code> 和 <code>passwords.yml</code> 到 <code>/etc/kolla</code> 目录下</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp -r /usr/share/kolla-ansible/etc_examples/kolla/* /etc/kolla</span></span><br></pre></td></tr></table></figure></li>
<li><p>拷贝 <code>all-in-one</code> 和 <code>multinode</code> 文件到当前目录下</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp /usr/share/kolla-ansible/ansible/inventory/* .</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="配置-ansible"><a href="#配置-ansible" class="headerlink" title="配置 ansible"></a>配置 ansible</h3><p>修改配置文件 <strong>/etc/ansible/ansible.cfg</strong> ，在 <strong>defaults</strong> 段中增加如下内容</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">host_key_checking=False</span><br><span class="line">pipelining=True</span><br><span class="line">forks=100</span><br></pre></td></tr></table></figure>

<h3 id="准备初始化配置"><a href="#准备初始化配置" class="headerlink" title="准备初始化配置"></a>准备初始化配置</h3><p><code>由于安装的All-In-One模式，所以直接使用文件all-in-one即可。</code></p>
<ol>
<li><p>检查使用文件 <code>all-in-one</code> 时，执行 <code>ansible</code> 的连通性</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ansible -i all-in-one all -m ping</span></span><br></pre></td></tr></table></figure></li>
<li><p>生成密码</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kolla-genpwd</span></span><br></pre></td></tr></table></figure></li>
<li><p>修改 <code>/etc/kolla/globals.yml</code> 配置文件，修改内容如下</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">kolla_base_distro: &quot;centos&quot;</span><br><span class="line">kolla_install_type: &quot;binary&quot;</span><br><span class="line">openstack_release: &quot;train&quot;</span><br><span class="line">network_interface: &quot;eth0&quot;</span><br><span class="line">neutron_external_interface: &quot;eth1&quot;</span><br><span class="line">kolla_internal_vip_address: &quot;172.16.140.15&quot;</span><br><span class="line">enable_haproxy: &quot;no&quot;</span><br><span class="line">enable_cinder: &quot;yes&quot;</span><br><span class="line">enable_ceph: &quot;yes&quot;</span><br></pre></td></tr></table></figure></li>
<li><p>由于使用 <code>ceph</code> 作为后端存储，所以在准备阶段，需要额外准备一块磁盘作为 <code>OSD</code> ，以下命令是为了在执行 <code>ansible</code> 脚本时，能识别此分区作为 <code>OSD</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> DISK=/dev/vdb</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> parted <span class="variable">$DISK</span> -s -- mklabel gpt mkpart KOLLA_CEPH_OSD_BOOTSTRAP_BS 1 -1</span></span><br></pre></td></tr></table></figure>

<p> 因为只有一台服务器作为 <code>All-In-One</code> 部署，所以对于 <code>ceph</code> 的配置需要先做预处理，将 <code>pool</code> 的 <code>size</code> 置为 1。新建目录 <code>/etc/kolla/config</code> ，然后在目录下创建配置文件 <code>ceph.conf</code> ，内容如下</p>
 <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">osd pool default size = 1</span><br><span class="line">osd pool default min size = 1</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h3><ol>
<li><p>完成带有 <code>kolla</code> 部署依赖的引导服务准备</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kolla-ansible -i ./all-in-one bootstrap-servers</span></span><br></pre></td></tr></table></figure></li>
<li><p>部署前的预检测</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kolla-ansible -i ./all-in-one prechecks</span></span><br></pre></td></tr></table></figure></li>
<li><p>开始部署</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kolla-ansible -i ./all-in-one deploy</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h2><hr>
<ol>
<li><p>安装 <code>OpenStack CLI</code> 客户端</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pip install python-openstackclient</span></span><br></pre></td></tr></table></figure></li>
<li><p>生成 <code>admin-openrc.sh</code> 文件</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt; kolla-ansible post-deploy</span></span><br></pre></td></tr></table></figure>

<p> 启用环境变量</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> . /etc/kolla/admin-openrc.sh</span></span><br></pre></td></tr></table></figure></li>
<li><p>获取 <code>cirros</code> 镜像</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span></span><br></pre></td></tr></table></figure>

<p> 如果没有 <code>wget</code> 工具，使用一下命令安装</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install wget -y</span></span><br></pre></td></tr></table></figure></li>
<li><p>上传 <code>cirros</code> 镜像</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openstack image create cirros-0.4.0-x86_64-disk.img --container-format bare --disk-format qcow2 --file cirros-0.4.0-x86_64-disk.img</span></span><br></pre></td></tr></table></figure>

<p> 查看上传的镜像</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openstack image list</span></span><br></pre></td></tr></table></figure>

<p> <img src="https://zbx-pic.oss-cn-shanghai.aliyuncs.com/iseeyou/20200206091856874.png" alt="images列表"></p>
</li>
<li><p>创建 <code>private</code> 网络</p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openstack network create private</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> openstack subnet create net --subnet-range 10.0.0.0/24 --gateway 10.0.0.1 --network 2c428b82-023e-4788-b37a-077e0effd2cc</span></span><br></pre></td></tr></table></figure></li>
<li><p>创建 <code>flavor</code></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openstack flavor create 1C1G10G --id 1 --ram 1024 --disk 10 --vcpus 1</span></span><br></pre></td></tr></table></figure></li>
<li><p>创建虚拟机</p>
<p> 准备工作完成</p>
<p> <img src="https://zbx-pic.oss-cn-shanghai.aliyuncs.com/iseeyou/20200206093551617.png" alt="ready"></p>
 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> openstack server create vm01 --image 46c1d789-f213-4fbd-bc8c-540a4194fab0 --flavor 1 --network 2c428b82-023e-4788-b37a-077e0effd2cc</span></span><br></pre></td></tr></table></figure>

<p> <img src="https://zbx-pic.oss-cn-shanghai.aliyuncs.com/iseeyou/2020020609392174.png" alt="servers 列表"></p>
<p> <img src="https://zbx-pic.oss-cn-shanghai.aliyuncs.com/iseeyou/20200206094121956.png" alt="虚拟机 console"></p>
</li>
</ol>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>centos</tag>
        <tag>kolla-ansible</tag>
        <tag>openstack</tag>
      </tags>
  </entry>
</search>
